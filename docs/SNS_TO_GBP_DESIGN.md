# SNS→GBP投稿流用機能 設計書

## 概要

**ペイン**: SNSとGBP（Googleビジネスプロフィール）両方に投稿するのは手間
**ソリューション**: SNS投稿を自動でGBPにも流用

## 機能一覧

### Phase 1（MVP）
- [x] X（Twitter）投稿の取得
- [x] Instagram投稿の取得（公開アカウントのみ）
- [x] GBP向けリライト（AI生成）
- [x] 管理画面での確認・編集・承認
- [ ] GBP投稿API連携（要Google Business Profile API）

### Phase 2（将来）
- [ ] 自動投稿（承認不要モード）
- [ ] 最適投稿時間の自動判定
- [ ] 画像リサイズ・最適化
- [ ] 投稿パフォーマンス分析

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│  SNS監視（定期実行）                                    │
├─────────────────────────────────────────────────────────┤
│  - X API v2 / スクレイピング                           │
│  - Instagram Basic Display API / スクレイピング        │
│  → 新規投稿を検出してDBに保存                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  GBP向けリライト（AI）                                  │
├─────────────────────────────────────────────────────────┤
│  - Claude API でリライト                               │
│  - 文字数制限（1500文字）対応                          │
│  - CTA追加（「詳しくはプロフィールへ」等）             │
│  - ハッシュタグ除去                                    │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  承認キュー（ダッシュボード）                           │
├─────────────────────────────────────────────────────────┤
│  - 元投稿とリライト案を並べて表示                      │
│  - 編集・承認・却下                                    │
│  - 投稿日時指定                                        │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  GBP投稿（手動 or API）                                 │
├─────────────────────────────────────────────────────────┤
│  - MVP: コピーボタン + GBP管理画面へのリンク           │
│  - 将来: Google Business Profile API で自動投稿        │
└─────────────────────────────────────────────────────────┘
```

---

## データベース設計

### sns_posts（SNS投稿）

```sql
CREATE TABLE sns_posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
  platform TEXT NOT NULL, -- 'x' | 'instagram'
  external_id TEXT NOT NULL, -- SNS側の投稿ID
  content TEXT NOT NULL,
  media_urls TEXT[], -- 画像/動画URL
  posted_at TIMESTAMPTZ NOT NULL,
  fetched_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(platform, external_id)
);
```

### gbp_drafts（GBP投稿下書き）

```sql
CREATE TABLE gbp_drafts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  store_id UUID REFERENCES stores(id) ON DELETE CASCADE,
  sns_post_id UUID REFERENCES sns_posts(id),
  original_content TEXT NOT NULL,
  rewritten_content TEXT NOT NULL,
  status TEXT DEFAULT 'pending', -- 'pending' | 'approved' | 'rejected' | 'posted'
  scheduled_at TIMESTAMPTZ,
  posted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## API設計

### GET /api/sns/posts
SNS投稿一覧を取得

### POST /api/sns/fetch
SNS投稿を手動で取得（Cron用）

### GET /api/gbp/drafts
GBP下書き一覧を取得

### POST /api/gbp/drafts/:id/approve
下書きを承認

### POST /api/gbp/drafts/:id/reject
下書きを却下

### PUT /api/gbp/drafts/:id
下書きを編集

---

## SNS取得方法

### X（Twitter）

**オプション1: X API v2（有料）**
- Basic: $100/月、読み取り専用
- 信頼性高い

**オプション2: スクレイピング（無料）**
- Playwright で公開アカウントを取得
- レート制限に注意

→ MVP では**スクレイピング**を採用（コスト優先）

### Instagram

**オプション1: Basic Display API（無料）**
- 自分のアカウントのみ
- ユーザー認証が必要

**オプション2: スクレイピング（無料）**
- 公開アカウントのみ
- 不安定

→ MVP では**スクレイピング**を採用（顧客アカウントを監視するため）

---

## リライトプロンプト

```
あなたはGoogleビジネスプロフィール（GBP）の投稿を最適化するエキスパートです。

以下のSNS投稿をGBP向けにリライトしてください。

【元の投稿（{platform}）】
{original_content}

【リライト要件】
- 1500文字以内
- ハッシュタグは除去
- 絵文字は控えめに（1-2個まで）
- 店舗への来店を促すCTAを追加
- ですます調で丁寧に
- 具体的な商品名・サービス名があれば維持

【出力形式】
リライトした文章のみを出力してください。
```

---

## 画面設計

### SNS→GBP承認画面 `/dashboard/sns-to-gbp`

```
┌─────────────────────────────────────────────────────────────┐
│ SNS→GBP投稿                                    [設定]       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📱 承認待ち (3件)                                          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ X投稿 2026/01/18 12:30                              │   │
│  │ ────────────────────────────────────────────────── │   │
│  │ 【元の投稿】                                        │   │
│  │ 今日のランチは特製つけ麺！🍜                        │   │
│  │ 麺は自家製、スープは鶏白湯ベース                    │   │
│  │ #新宿ラーメン #つけ麺 #限定メニュー                  │   │
│  │ ────────────────────────────────────────────────── │   │
│  │ 【GBP向けリライト案】                               │   │
│  │ 本日のおすすめは特製つけ麺です。                    │   │
│  │ 自家製麺と鶏白湯ベースのスープが自慢の一杯。        │   │
│  │ ランチタイムにぜひお立ち寄りください。              │   │
│  │ ────────────────────────────────────────────────── │   │
│  │ [編集] [承認してコピー] [却下]                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 実装タスク

1. [x] 設計書作成
2. [ ] DBマイグレーション追加
3. [ ] X投稿取得スクレイパー
4. [ ] Instagram投稿取得スクレイパー
5. [ ] GBPリライトAPI
6. [ ] 承認画面UI
7. [ ] Cron設定（1時間ごと）

---

*作成日: 2026/01/18*
